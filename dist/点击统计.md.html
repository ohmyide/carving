<!DOCTYPE html>
<html>
<head>
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta charset="utf-8">
   <title>Documents</title>
   <meta name="description" content="">
   <meta name="author" content="">
   <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1">
   <link rel="stylesheet" href="./assets/test.css">
   <link rel="shortcut icon" href="">
   <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?11bc17e004cc00e2ed1d71777294097e";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</head>

<body dir="ltr">
    <div class="wrap">
        <header>
            <div class="header-wrap">
                <a class="site-title header-item" href="./">
                    Oh My IDE
                    <b class="command_prompt"></b>
                    <b class="blinking_cursor">_</b>
                </a>
                <a class="header-item" href="./about.html">README</a>
            </div>
        </header>
        <main class="container">

<p>在微信上做一次推广活动，页面共计三个按钮，需要分别统计点击次数，pc上的相关统计用的是“百度统计”，因为H5活动页的时效性等原因，并没有使用百度统计，而是自己实现一个简单的统计小方案：前端点击时请求一个空白小gif图，带有参数，后端同事根据nginx请求日志做统计，通过在cookie中存入一个不会重叠的时间戳作为key值来区分是否同一用户（uv）。</p>
<!-- more -->
<p>请求的图片存在七牛中，是固定不变的，主要变化是后面两个参数：用户标识uid和按钮标识，其中生成不重复（把重复率降到最低）的用户标识很有意思，可参考<a href="http://div.io/topic/574" target="_blank" rel="noopener">这篇文章</a>。</p>
<p>时间戳用<code>new Date().getTime()</code>得出一个13位的“随机数”，精确到毫秒，但万一同一毫秒有两个以上用户点击呢？于是再严谨一些，用for循环在随机一个5位字符串拼接，这样的重复率绝对够用：</p>
<pre class="hljs"><code>uid = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
<span class="hljs-keyword">var</span> randomNumber = <span class="hljs-string">&#x27;&#x27;</span>;
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span> ; i &lt; <span class="hljs-number">5</span> ; i ++){
    randomNumber += <span class="hljs-keyword">new</span> <span class="hljs-built_in">String</span> (<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">10</span>));
}
uid = uid + randomNumber;
</code></pre>
<p>下面是具体逻辑代码，当网页中已有请求图片时，更改url的参数也一样能从新发起一个get请求，避免每次点击都append一张图片。这种实现方法感觉比点击发送ajax更加方便。</p>
<pre class="hljs"><code>		statistics: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">position</span>)</span>{
			<span class="hljs-keyword">var</span> pic = <span class="hljs-string">&quot;http://wx.daigj.com/notification/statistics/p.gif&quot;</span>;
			<span class="hljs-keyword">var</span> uid = util.readCookie(<span class="hljs-string">&quot;uid&quot;</span>);
			<span class="hljs-keyword">var</span> imgLength = $(<span class="hljs-string">&quot;#statistics-img&quot;</span>).length;
			<span class="hljs-keyword">if</span>(uid){
				<span class="hljs-keyword">if</span>(imgLength == <span class="hljs-number">0</span>){
					$(<span class="hljs-string">&#x27;body&#x27;</span>).append(<span class="hljs-string">&#x27;&lt;img id=&quot;statistics-img&quot; src=&quot;&#x27;</span> + pic + <span class="hljs-string">&#x27;?uid=&#x27;</span>+ uid + <span class="hljs-string">&#x27;&amp;position=&#x27;</span>+ position +<span class="hljs-string">&#x27;&quot;/&gt;&#x27;</span>);
				}<span class="hljs-keyword">else</span>{
					$(<span class="hljs-string">&quot;#statistics-img&quot;</span>).attr(<span class="hljs-string">&quot;src&quot;</span>,pic+<span class="hljs-string">&quot;?uid=&quot;</span>+uid+<span class="hljs-string">&quot;&amp;position=&quot;</span>+position);
				}
			}<span class="hljs-keyword">else</span>{
				uid = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
				<span class="hljs-keyword">var</span> randomNumber = <span class="hljs-string">&#x27;&#x27;</span>;
		        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span> ; i &lt; <span class="hljs-number">5</span> ; i ++){
		            randomNumber += <span class="hljs-keyword">new</span> <span class="hljs-built_in">String</span> (<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">10</span>));
		        }
		        uid = uid + randomNumber;
				util.createCookie(<span class="hljs-string">&quot;uid&quot;</span>,uid);
				$(<span class="hljs-string">&#x27;body&#x27;</span>).append(<span class="hljs-string">&#x27;&lt;img id=&quot;statistics-img&quot; src=&quot;&#x27;</span> + pic + <span class="hljs-string">&#x27;?uid=&#x27;</span>+ uid + <span class="hljs-string">&#x27;&amp;position=&#x27;</span>+ position +<span class="hljs-string">&#x27;&quot;/&gt;&#x27;</span>);
			}
		}
</code></pre>
        <main>
        <div class="progress-indicator">我是页脚</div>
    <div class="wrap">
</body>
</html>